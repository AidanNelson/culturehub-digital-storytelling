<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      html,
      body {
        margin: 20px;
        padding: 0px;
        overflow: scroll;
        color:black;
      }
    </style>


    <script src="../libs/socket.io.js"></script>
    <script src="tracery.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="playscriptTemplate.js"></script>
  </head>
  <body>
    <button onclick="generateScript()">Generate</button>
    <button onclick="getDreams()">Get Dreams</button>
    <div id="container">
        <p><button id="sendLine">Send</button><span id="nextLine"></span></p>
        <pre></pre>
    </div>
      <script>
        let socket;
        let dreams;
        let lines = []
        let counter = 0;
        let grammarObj = {
            "place": ["SEARS"],
            "person":["Todd"],
            "sound":["airhorn"],
            "lovedOne":["Mom"],
            "color":["blue"],
            "whatIsADream":["a star"],
            "dreampast":["we will forget"],
            "dreampresent": ["being a gundam"],
            "dreamfuture":["the sea covers us all"],
            "scriptTemplate":[scriptTemplate]
        }
        let grammar = tracery.createGrammar(grammarObj);

        if (window.location.hostname === 'venue.itp.io') {
          socket = io('https://venue.itp.io');
        } else {
          socket = io('http://localhost:3131');
        }
        socket.on('alldreams', (data) => {
          dreams = data
          data.forEach((dream)=> {
            dream.dream = dream.dream.trim()
            if(!grammarObj[dream.type].includes(dream.dream)){
              grammarObj[dream.type].push(dream.dream)
            }
          })
          grammar = tracery.createGrammar(grammarObj);
          console.log(dreams)
        })
        $('#sendLine').click(function(){
          socket.emit("data", {type:"dreamLine", line:lines[counter]})
          counter++
          $('#nextLine').html(lines[counter])
        })
        function generateScript(){
          let script = grammar.flatten("#scriptTemplate#")
        console.log(script)
        $('pre').text(script)
        lines = script.split("A:")
        console.log(lines)
        let temp = []
          lines.forEach((line) => {
            line = line.replace(/(\r\n|\n|\r)/gm, " ");
            line = "<span class='ALine'>A: " + line
            line = line.replace("B:", "</span><br><span class='BLine'>B:") + "</span>" 
            temp.push(line)
          })
          lines = temp
          $('#nextLine').html(temp[counter])
        }
        function getDreams(){
          console.log(socket)
          socket.emit("getdreams")
          console.log('getting dreams')
        }
      </script>
    </div>
  </body>
</html>
